<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tonerliste</title>
  <link href="../lib/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 5px;
    }
  </style>
  <link href="css/style.css" rel="stylesheet">
  <link href="../lib/css/bootstrap-responsive.min.css" rel="stylesheet">
</head>
<body>


  <div class="container"> 
    <center><h1>Tonerliste</h1></center>
    <div class="page"></div>
  </div>


  <script src="../lib/js/jquery-1.8.3.min.js" type="text/javascript"></script>
  <script src="../lib/js/bootstrap.min.js" type="text/javascript"></script>  
  <script src="../lib/js/underscore-min.js" type="text/javascript"></script>
  <script src="../lib/js/backbone-min.js" type="text/javascript"></script>
  <script type="text/template" id="toner-list-template">        
    <div class="well-box">
      <table class="table table-hover table-condensed">
        <p><a href="#new" class="btn btn-small btn-primary"><i class="icon-plus icon-white"></i> Modell hinzufügen</a>
        <% if(hidden==0){ %>
        <a href="#all" class="btn btn-info btn-mini"><i class="icon-eye-open icon-white"></i> Versteckte Einblenden</a></p>
        <% }else{ %>
        <a href="#" class="btn btn-info btn-mini"><i class="icon-eye-close icon-white"></i> Versteckte Ausblenden</a></p>
        <% } %>
        <thead>
          <tr>
            <th>Drucker</th>
            <th>Modell</th>
            <th>Typ</th>
            <th>Farbe</th>
            <th>Anzahl</th>
            <th></th>
          </tr>
        </thead>
        <tobdy>
          <% _.each(toners, function(toner){ %>
          <% if(toner.get('hidden')==0||hidden==1){ %>
            <tr class="<%- toner.get('stock')>0&&toner.get('stock')<3 ? 'warning' :'' %>
            <%- toner.get('stock')==0 ? 'error' : '' %>">
              <td><%- toner.get('printer') %></td>
              <td><%- toner.get('name') %></td>
              <td><%- toner.get('typ')==1 ? 'Toner' : 'Trommel'  %></td>
              <td><%  var color = toner.get('color')%>
              <%- color==1 ? 'black' : '' %>
              <%- color==2 ? 'magenta' : '' %>
              <%- color==3 ? 'cyan' : '' %>
              <%- color==4 ? 'yellow' : '' %>
              <%- color==5 ? 'universal' : '' %></td>
              <td><%- toner.get('stock') %></td>
              <td>
                <div class="btn-group">
                  <a href="#/stock/<%- toner.id %>/2" class="btn btn-small"><i class="icon-minus icon"></i></a>
                  <a href="#/edit/<%- toner.id %>" class="btn btn-small btn-warning"><i class="icon-edit icon-white"></i> Ändern</a>
                  <a href="#/stock/<%- toner.id %>/1" class="btn btn-small"><i class="icon-plus"></i></a>
                </div>
              </td>
            </tr>
          <% }}); %>
        </tbody>
      <tables>
    </div>
  </script>

  <script type="text/template" id="edit-toner-template">
    <form class="edit-toner-form">
      <div class="well-box">        
        <div class="well-box span3">
          <legend class="legend-blank"><%- toner ? 'Ändere ein ' : 'Erstelle ein ' %>Modell</legend>
          <label>Drucker</label>
          <input type="text" name="printer" value='<%- toner ? toner.get('printer') : '' %>'>
          <label>Modell</label>
          <input type="text" name="model" value='<%- toner ? toner.get('name') : '' %>'>
          <label>Typ</label>
          <select name="type">
            <option <%- toner&&toner.get('type')=='Toner' ? 'selected="selected"' : '' %>>Toner</option>
            <option <%- toner&&toner.get('type')=='Trommel' ? 'selected="selected"' : '' %>>Trommel</option>
          </select>
          <label>Farbe</label>
          <select name="color">
            <option <%- toner&&toner.get('color')=='black' ? 'selected="selected"' : '' %>>black</option>
            <option <%- toner&&toner.get('color')=='magenta' ? 'selected="selected"' : '' %>>magenta</option>
            <option <%- toner&&toner.get('color')=='cyan' ? 'selected="selected"' : '' %>>cyan</option>
            <option <%- toner&&toner.get('color')=='yellow' ? 'selected="selected"' : '' %>>yellow</option>
            <option <%- toner&&toner.get('color')=='universal' ? 'selected="selected"' : '' %>>universal</option>
          </select>
          <% if(toner){ %>
            <label>Anzahl</label>
            <input type="text" class="input-mini"id="stock" name="stock" value="<%- toner.get('stock') %>"></input>
            <button class="btn btn-small btn btn-inverse" type="button" onclick="$('#stock').val(parseInt($('#stock').val())+1)"><i class="icon-plus icon-white"></i></button>
            <button class="btn btn-small btn " type="button" onclick="$('#stock').val( parseInt($('#stock').val()) < 1 ? '0' :  parseInt($('#stock').val()) - 1)"><i class="icon-minus icon"></i></button>
          <% } %>
          <label>Sichbarkeit</label>
          <select name="type">
            <option <%- toner&&toner.get('hidden')=='Sichtbar' ? 'selected="selected"' : '' %>>Sichtbar</option>
            <option <%- toner&&toner.get('hidden')=='Versteckt' ? 'selected="selected"' : '' %>>Versteckt</option>
          </select>
          <hr/ >
          <% if(toner){ %>
            <label>Änderungsgrund</label>
            <input type="text" name="reason"></input></br>
            <input type ="hidden" name="id" value="<%- toner.id %>"></input>
          <% }; %>
          <button type="submit" class="btn btn-success"><%- toner ? 'Ändern' : 'Erstellen' %></button>
          <a href="#" class="btn ">Abbrechen</a>
        </div>   
        <% if(toner){ %>      
        <div class="well-box span8" style="height:587px; overflow:auto;">
          <legend>Verlauf</legend>   
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Aktion</th>
                <th>Benutzer</th>
                <th>Grund</th>
              </tr>
            </thead>
            <tobdy>   
            <% _.each(toner.get('transactions'), function(elems) { %>
            <tr>
              <td><%- elems.date %></td>
              <td>
              <%- elems.type==1 ? 'Erhöht' : '' %>
              <%- elems.type==2 ? 'Verringert' : '' %>
              <%- elems.type==3 ? 'Erstellt' : '' %>
              <%- elems.type==4 ? 'Editiert' : '' %>
              </td>
              <td><%- elems.name %></td>
              <td><%- elems.reason %></td>
            </tr>
            <% }); %>
            </tobdy> 
          </table>
        </div>
        <% } %>
      </div>
    </form>
  </script>

  <script>

    $.fn.serializeObject = function() {
      var o = {};
      var a = this.serializeArray();
      $.each(a, function() {
          if (o[this.name] !== undefined) {
              if (!o[this.name].push) {
                  o[this.name] = [o[this.name]];
              }
              o[this.name].push(this.value || '');
          } else {
              o[this.name] = this.value || '';
          }
      });
      return o;
    };

    var Toners = Backbone.Collection.extend({
      url: '/api/tonerliste/'
    });

    var Toner = Backbone.Model.extend({
      urlRoot: '/api/tonerliste/toner'
    });

    var Stock = Backbone.Model.extend({
      urlRoot: '/api/tonerliste/'
    });

    var TonerList = Backbone.View.extend({
      el: '.page',
      render : function(hidden) {
        var that = this;
        var toners = new Toners();
        toners.fetch({
          success: function(toners){ 
            var template = _.template($('#toner-list-template').html(), {toners: toners.models, hidden: hidden});          
            that.$el.html(template);
          }
        });
      }
    });






    var ChangeStock = Backbone.View.extend({
      el: '.page',
      render: function(id, action){

      }
    });








    var EditToner = Backbone.View.extend({
      el: '.page',
      render: function(options){
        var that = this;
        if(options.id){
          var toner = new Toner({id: options.id});
          toner.fetch({
            success: function(toner){         
              var template = _.template($('#edit-toner-template').html(), {toner: toner});
              that.$el.html(template);
            },
            error: function(){
              console.log(arguments); 
            }
          })
        } else {
          var template = _.template($('#edit-toner-template').html(), {toner: null});
          this.$el.html(template);
        }
      },
      events: {
        'submit .edit-toner-form': 'saveToner',
      },
      saveToner: function(ev){
        var tonerDetails = $(ev.currentTarget).serializeObject();
        tonerDetails['type'] = tonerDetails['type'] == 'Toner' ? '1' : '2';
        switch(tonerDetails['color']){
          case 'black' : tonerDetails['color']='1'; break;
          case 'magenta' : tonerDetails['color']='2'; break;
          case 'cyan' : tonerDetails['color']='3'; break;
          case 'yellow' : tonerDetails['color']='4'; break;
          case 'universal' : tonerDetails['color']='5'; break;
          default : tonerDetails['color']='6'; break;
        }
        var toner = new Toner();
        toner.save(tonerDetails, {
          success: function(toner) {
            router.navigate('', {trigger: true});
          }
        });
        return false;
     }
    }); 

    var Router = Backbone.Router.extend({
      routes: {
        '': 'home',
        'all': 'all',
        'new': 'editToner',
        'edit/:id': 'editToner',
        'stock/:id/:action' : 'changeStock'
      }
    });

    var tonerList = new TonerList();
    var editToner = new EditToner();
    var changeStock = new ChangeStock();

    var router = new Router;
    router.on('route:home', function(){
      tonerList.render(0);
    });

    router.on('route:all', function(){
      tonerList.render(1);
    });

    router.on('route:editToner', function(id){
      editToner.render({id: id});
    });

    router.on('route:changeStock', function(id, action){
      changeStock.render(id,action);
    });

    Backbone.history.start();

  </script>


</body>
</html> 



